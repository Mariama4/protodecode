import unittest

from protodecode import decode_grpc


class TestDecodeGrpc(unittest.TestCase):
    def test_decode_plain_protobuf_varint(self):
        result = decode_grpc("08 96 01")
        self.assertEqual(result, ["150"])

    def test_decode_grpc_framed_varint(self):
        # 00 + 4-byte big-endian length (3) + protobuf payload.
        result = decode_grpc("00 00 00 00 03 08 96 01")
        self.assertEqual(result, ["150"])

    def test_decode_grpc_large_framed_payload(self):
        result = decode_grpc(
            "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gAAAABBncnBjLXN0YXR1czogMA0K"
        )
        self.assertEqual(len(result), 40)
        self.assertEqual(
            result[0],
            ["86", "ООО БОРЕЙ", "Рокет Ворк", "₽", "2024-02-19T09:05:46.7937740+00:00"],
        )
        self.assertEqual(
            result[38],
            [
                "572",
                'ООО "ВИРАЖ-СПБ"',
                "Рокет Ворк",
                "1",
                10.0,
                "₽",
                "2026-02-04T06:08:49.7055010+00:00",
            ],
        )
        self.assertEqual(result[39], "39")

    def test_decode_text_field_without_false_nested_protobuf(self):
        result = decode_grpc(
            "08 bc 04 12 1a d0 9e d0 9e d0 9e 20 22 d0 92 d0 98 d0 a0 d0 90 d0 96 2d d0 a1 d0 9f d0 91 22"
        )
        self.assertEqual(result, ["572", 'ООО "ВИРАЖ-СПБ"'])


if __name__ == "__main__":
    unittest.main()
